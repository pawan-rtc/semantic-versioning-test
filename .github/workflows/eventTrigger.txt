name: PR and Push Events

on:
  pull_request:
    types:
      - opened
      - closed
  push:
    branches:
      - main
      - develop
      - test

jobs:
  process_events:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      # PR opened notif
      - name: PR Opened
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        run: |
          echo "New PR Created"

          echo "Sending Slack notification..."
          echo "::set-env name=SLACK_PAYLOAD::{
                \"text\": \"PR: ${{ github.event.pull_request.title }} by ${{ github.event.pull_request.user.login }}\",
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \":sparkles: *Incoming PR* :sparkles: \\n *By:* <${{ github.event.pull_request.user.html_url }}|${{ github.event.pull_request.user.login }}> \\n *Link:* <${{ github.event.pull_request.html_url }}|${{ github.event.pull_request.title }}> | *Commit:* <${{ github.event.pull_request.head.repo.html_url }}/commit/${{ github.event.pull_request.head.sha }}|${{ github.event.pull_request.head.sha }}>\"
                    }
                  } 
                ] 
              }"
              
          curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${{ secrets.SLACK_TOKEN }}" -d "$SLACK_PAYLOAD" https://slack.com/api/chat.postMessage

      # PR merge notif
      - name: PR Merged
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          echo "PR merged"

          echo "Sending Slack notification for PR merged..."
          echo "::set-env name=SLACK_PAYLOAD::{
            \"text\": \"PR merged: ${{ github.event.pull_request.title }}\",
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \":rocket: *Merged*\\n* By:* <${{ github.event.pull_request.merged_by.html_url }}|${{ github.event.pull_request.merged_by.login }}>\\n*Link:* <${{ github.event.pull_request.html_url }}|${{ github.event.pull_request.title }}>\"
                }
              } 
            ] 
          }"

          curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${{ secrets.SLACK_TOKEN }}" -d "$SLACK_PAYLOAD" https://slack.com/api/chat.postMessage

      # release, on push to a branch
      - name: Push to Branch
        if: github.event_name == 'push' && github.event_name != 'pull_request'
        run: #release code here
